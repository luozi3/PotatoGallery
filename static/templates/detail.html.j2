<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ image.title }} ｜ {{ site_name }}</title>
  <meta name="description" content="{{ image.description or image.original_name }}">
  <meta name="theme-color" content="{{ site.theme_color }}">
  {% include "partials/theme_init.html.j2" %}
  {% if canonical_url %}
  <link rel="canonical" href="{{ canonical_url }}">
  {% endif %}
  <meta property="og:title" content="{{ image.title }}">
  <meta property="og:description" content="{{ image.description or image.original_name }}">
  <meta property="og:type" content="article">
  <meta property="og:locale" content="{{ site.locale }}">
  {% if canonical_url %}
  <meta property="og:url" content="{{ canonical_url }}">
  {% endif %}
  {% if image_url %}
  <meta property="og:image" content="{{ image_url }}">
  {% endif %}
  <meta name="twitter:card" content="summary_large_image">
  <link rel="stylesheet" href="/static/styles/gallery.css?v={{ static_version }}">
  {% if site.live2d.enabled %}
  <link rel="stylesheet" href="{{ site.live2d.base_url }}/live2d/css/live2d.css">
  {% endif %}
  {% if json_ld %}
  <script type="application/ld+json">{{ json_ld | safe }}</script>
  {% endif %}
</head>
<body class="page-detail with-sidebar" data-sidebar-default="collapsed">
  {% macro render_tag_tree(nodes, depth=0) -%}
    <ul class="{{ 'tag-tree' if depth == 0 else 'tag-branch' }}">
      {% for node in nodes %}
      <li class="tag-node{% if not node.explicit %} is-implicit{% endif %}">
        <a class="tag-chip" href="/tags/{{ node.slug|urlencode }}/" style="{{ node.style }}">#{{ node.tag }}</a>
        {% if node.children %}
        {{ render_tag_tree(node.children, depth + 1) }}
        {% endif %}
      </li>
      {% endfor %}
    </ul>
  {%- endmacro %}
  {% set orientation_labels = {"portrait": "竖屏", "landscape": "横屏", "square": "方形", "unknown": "未标"} %}
  {% set size_labels = {"ultra": "超清", "large": "高清", "medium": "中等", "compact": "轻量", "unknown": "未标"} %}
  {% set thumb_src = "/thumb/" ~ image.thumb_filename if image.thumb_filename else "/raw/" ~ image.raw_filename %}
  {% set full_src = "/raw/" ~ image.raw_filename %}
  {% set thumb_width = image.thumb_width or image.width %}
  {% set thumb_height = image.thumb_height or image.height %}
  <a class="skip-link" href="#main-content">跳到主要内容</a>
  {% include "partials/topbar.html.j2" %}

  <main class="detail-shell" id="main-content" tabindex="-1">
    {% include "partials/sidebar_default.html.j2" %}
    <aside class="detail-static-sidebar" aria-label="标签与索引">
      <div class="left-sidebar-inner">
        <div class="side-group">
          <div class="side-heading">标签</div>
          {% if image.tag_groups %}
          <div class="tag-groups">
            {% for group in image.tag_groups %}
            <div class="tag-group">
              <div class="tag-group-head">
                <span class="tag-group-dot" style="background: {{ group.color }};"></span>
                <span class="tag-group-title">{{ group.label }}</span>
              </div>
              <div class="tag-flat-list">
                {% for item in group.tags %}
                <a class="tag-flat-chip{% if not item.explicit %} is-implicit{% endif %}" href="/tags/{{ item.slug|urlencode }}/" style="{{ item.style }}">#{{ item.tag }}</a>
                {% endfor %}
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="muted">暂无标签</p>
          {% endif %}
        </div>
        <div class="side-group">
          <div class="side-heading">信息</div>
          <dl class="detail-meta-list">
            <div>
              <dt>编号</dt>
              <dd>#{{ image.short_id or image.uuid }}</dd>
            </div>
            <div>
              <dt>分辨率</dt>
              <dd>{{ image.width }} × {{ image.height }}</dd>
            </div>
            <div>
              <dt>体积</dt>
              <dd>{{ image.bytes_human }}</dd>
            </div>
            <div>
              <dt>上传时间</dt>
              <dd>{{ image.created_at }}</dd>
            </div>
            <div>
              <dt>SHA256</dt>
              <dd class="mono">{{ image.sha256 }}</dd>
            </div>
            <div>
              <dt>主色</dt>
              <dd><span class="color-chip" style="background: {{ image.dominant_color or '#dfe4ea' }};"></span>{{ image.dominant_color or '未知' }}</dd>
            </div>
            <div>
              <dt>原文件</dt>
              <dd>{{ image.original_name }}</dd>
            </div>
            <div>
              <dt>标记</dt>
              <dd>{{ orientation_labels.get(image.orientation, "未标") }} / {{ size_labels.get(image.size_bucket, "未标") }}</dd>
            </div>
          </dl>
        </div>
      </div>
    </aside>
    <section class="detail-main">
      <header class="detail-head">
        <p class="eyebrow">{{ collections.get(image.collection, {}).get('title', image.collection) }}</p>
        <h1 class="detail-title">{{ image.title }}</h1>
        {% if image.description %}
        <p class="desc">{{ image.description }}</p>
        {% endif %}
        <p class="detail-original">{{ image.original_name }}</p>
        <div class="tag-row">
          <span class="tag accent">{{ image.width }}×{{ image.height }}</span>
          <span class="tag">{{ image.bytes_human }}</span>
          <span class="tag ghost">{{ image.created_at }}</span>
          <span class="tag ghost">{{ orientation_labels.get(image.orientation, "未标") }}</span>
          <span class="tag ghost">{{ size_labels.get(image.size_bucket, "未标") }}</span>
        </div>
      </header>
      <section class="detail-media" data-detail-media data-image-mode="thumb">
        <div class="detail-media-actions">
          <a class="detail-action" href="/raw/{{ image.raw_filename }}" download>下载原图</a>
        </div>
        <div class="frame detail-frame" style="aspect-ratio: {{ image.width }}/{{ image.height }};">
          <div class="detail-overlay">
            <span class="detail-hint">点击图片在缩略/原图之间切换</span>
            <span class="detail-mode">模式：<span data-image-status>略缩图</span></span>
          </div>
          <img class="detail-image"
               src="{{ thumb_src }}"
               alt="{{ image.original_name }}"
               loading="eager"
               decoding="async"
               width="{{ thumb_width }}"
               height="{{ thumb_height }}"
               data-detail-image
               data-thumb-src="{{ thumb_src }}"
               data-full-src="{{ full_src }}"
               onerror="this.onerror=null;this.src='{{ full_src }}';">
        </div>
      </section>
      <section class="panel edit-panel" data-image-editor data-image-uuid="{{ image.uuid }}" hidden>
        <h2>作品管理</h2>
        <div class="admin-fields">
          <label class="label">标题</label>
          <input class="admin-input" type="text" data-image-field="title">
          <label class="label">正文说明</label>
          <textarea class="admin-textarea" data-image-field="description"></textarea>
          <label class="label">标签</label>
          <input class="admin-tag-input" type="text" data-image-field="tags" placeholder="tag1 tag2" data-tag-input>
          <p class="hint">编辑标签无需 #，用空格分隔即可。</p>
          <label class="label">分区</label>
          <select class="admin-select" data-image-field="collection"></select>
          <div class="admin-actions-row">
            <button class="btn primary" type="button" data-image-save>保存</button>
            <p class="hint" data-image-status></p>
          </div>
        </div>
      </section>
    </section>
  </main>

  {% if site.counter.enabled and site.counter.img_url %}
  <div class="counter">
    <img src="{{ site.counter.img_url }}" alt="访问统计" loading="lazy" referrerpolicy="no-referrer">
  </div>
  {% endif %}

  {% if site.live2d.enabled %}
  {% set live2d_width = site.live2d.width or 300 %}
  {% set live2d_height = site.live2d.height or 336 %}
  <div id="landlord" class="live2d-root" aria-hidden="true" style="--live2d-width: {{ live2d_width }}px; --live2d-height: {{ live2d_height }}px;">
    <div class="message" style="opacity:0"></div>
    <canvas id="{{ site.live2d.canvas_id }}" width="{{ live2d_width }}" height="{{ live2d_height }}" class="live2d"></canvas>
  </div>
  <script src="{{ site.live2d.base_url }}/live2d/js/Setting.js" defer onerror="var r=document.getElementById('landlord');if(r){r.style.display='none';}"></script>
  <script src="{{ site.live2d.base_url }}/jquery.min.js" defer onerror="var r=document.getElementById('landlord');if(r){r.style.display='none';}"></script>
  <script src="{{ site.live2d.base_url }}/live2d/js/message.js" defer onerror="var r=document.getElementById('landlord');if(r){r.style.display='none';}"></script>
  <script src="{{ site.live2d.base_url }}/bundle.js" defer onerror="var r=document.getElementById('landlord');if(r){r.style.display='none';}"></script>
  <script>
    window.addEventListener('load', function () {
      if (!window.loadlive2d) return;
      try {
        loadlive2d("{{ site.live2d.canvas_id }}", "{{ site.live2d.model }}");
      } catch (e) {
        const root = document.getElementById('landlord');
        if (root) root.style.display = 'none';
      }
    });
  </script>
  {% endif %}

  <script src="/static/js/ui.js?v={{ static_version }}" defer></script>
  <script src="/static/js/gallery.js?v={{ static_version }}" defer></script>
  <script src="/static/js/user.js?v={{ static_version }}" defer></script>
</body>
</html>
