<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ image.title }} ｜ {{ site_name }}</title>
  <meta name="description" content="{{ image.description or image.original_name }}">
  <meta name="theme-color" content="{{ site.theme_color }}">
  {% if canonical_url %}
  <link rel="canonical" href="{{ canonical_url }}">
  {% endif %}
  <meta property="og:title" content="{{ image.title }}">
  <meta property="og:description" content="{{ image.description or image.original_name }}">
  <meta property="og:type" content="article">
  <meta property="og:locale" content="{{ site.locale }}">
  {% if canonical_url %}
  <meta property="og:url" content="{{ canonical_url }}">
  {% endif %}
  {% if image_url %}
  <meta property="og:image" content="{{ image_url }}">
  {% endif %}
  <meta name="twitter:card" content="summary_large_image">
  <link rel="stylesheet" href="/static/styles/gallery.css?v={{ static_version }}">
  {% if site.live2d.enabled %}
  <link rel="stylesheet" href="{{ site.live2d.base_url }}/live2d/css/live2d.css">
  {% endif %}
  {% if json_ld %}
  <script type="application/ld+json">{{ json_ld | safe }}</script>
  {% endif %}
</head>
<body class="page-detail">
  {% set orientation_labels = {portrait: 竖屏, landscape: 横屏, square: 方形, unknown: 未标} %}
  {% set size_labels = {ultra: 超清, large: 高清, medium: 中等, compact: 轻量, unknown: 未标} %}
  <a class="skip-link" href="#main-content">跳到主要内容</a>
  <header class="topbar">
    <div class="topbar-left">
      <a class="brand" href="/" aria-label="返回首页">
        <span class="logo-dot" aria-hidden="true"></span>
        <div class="brand-text">
          <strong>{{ site.brand_name or site_name }}</strong>
          <span>{{ site.brand_tagline }}</span>
        </div>
      </a>
      <button class="icon-button theme-toggle" type="button" data-theme-toggle aria-label="切换主题">
        <span class="icon" aria-hidden="true">◐</span>
      </button>
    </div>
    <nav class="topnav" aria-label="顶栏导航">
      <a href="/">首页</a>
      <a href="/tags/">标签</a>
      <a href="/favorites/" data-auth-user-link hidden>收藏</a>
    </nav>
    <div class="topbar-right">
      <button class="search-trigger" type="button" data-search-open aria-label="打开搜索">搜索标题、描述、标签</button>
      {% if site.live2d.enabled %}
      <button class="icon-button live2d-toggle" type="button" data-live2d-toggle aria-label="切换 Live2D">Live2D</button>
      {% endif %}
      <span class="user-avatar" data-user-avatar hidden>
        <img src="{{ site.auth_avatar_url }}" alt="用户头像" loading="lazy" width="32" height="32" data-user-avatar-img>
      </span>
      <a class="icon-link" href="/my/" data-auth-user-link hidden>我的作品</a>
      <a class="icon-link" href="/favorites/" data-auth-user-link hidden>我的收藏</a>
      <a class="icon-link" href="/auth/login/" data-auth-login-link>登录</a>
      {% if auth.registration_mode != "closed" %}
      <a class="icon-link" href="/auth/register/" data-auth-register-link>注册</a>
      {% endif %}
      <a class="icon-link admin-entry" href="/admin/" data-admin-entry hidden>管理</a>
      <a class="icon-link admin-entry" href="/admin/tags/" data-admin-entry hidden>标签管理</a>
      <a class="icon-link admin-entry" href="/status/" data-admin-entry hidden>状态</a>
    </div>
  </header>

  <main class="detail-layout" id="main-content" tabindex="-1">
    <div class="visual">
      <div class="frame" style="aspect-ratio: {{ image.width }}/{{ image.height }};">
        <img src="/raw/{{ image.raw_filename }}"
             alt="{{ image.original_name }}"
             loading="eager"
             fetchpriority="high"
             width="{{ image.width }}"
             height="{{ image.height }}">
      </div>
    </div>
    <div class="panel">
      <p class="eyebrow">{{ collections.get(image.collection, {}).get('title', image.collection) }}</p>
      <h1 class="detail-title">{{ image.title }}</h1>
      {% if image.description %}
      <p class="desc">{{ image.description }}</p>
      {% endif %}
      <p class="muted">{{ image.original_name }}</p>
      <div class="tag-row">
        <span class="tag accent">{{ image.width }}×{{ image.height }}</span>
        <span class="tag">{{ image.bytes_human }}</span>
        <span class="tag ghost">{{ image.created_at }}</span>
        <span class="tag ghost">{{ orientation_labels.get(image.orientation, "未标") }}</span>
        <span class="tag ghost">{{ size_labels.get(image.size_bucket, "未标") }}</span>
      </div>
      {% if image.tags %}
      <div class="tags">
        {% for tag in image.tags %}
        <a class="tag ghost" href="/tags/{{ tag_slug_map.get(tag, tag)|urlencode }}/">#{{ tag }}</a>
        {% endfor %}
      </div>
      {% endif %}
      <dl class="meta-grid">
        <div>
          <dt>文件名</dt>
          <dd>{{ image.original_name }}</dd>
        </div>
        <div>
          <dt>分辨率</dt>
          <dd>{{ image.width }} × {{ image.height }}</dd>
        </div>
        <div>
          <dt>SHA256</dt>
          <dd class="mono">{{ image.sha256 }}</dd>
        </div>
        <div>
          <dt>主色</dt>
          <dd><span class="color-chip" style="background: {{ image.dominant_color or '#dfe4ea' }};"></span>{{ image.dominant_color or '未知' }}</dd>
        </div>
        <div>
          <dt>原图</dt>
          <dd><a href="/raw/{{ image.raw_filename }}" download>下载 / 查看</a></dd>
        </div>
        <div>
          <dt>上传时间</dt>
          <dd>{{ image.created_at }}</dd>
        </div>
      </dl>
      <div class="actions">
        <a class="btn primary" href="/raw/{{ image.raw_filename }}" download>下载原图</a>
        <a class="btn ghost" href="/">回到首页</a>
      </div>
      <section class="panel edit-panel" data-image-editor data-image-uuid="{{ image.uuid }}" hidden>
        <h2>作品管理</h2>
        <div class="admin-fields">
          <label class="label">标题</label>
          <input class="admin-input" type="text" data-image-field="title">
          <label class="label">正文说明</label>
          <textarea class="admin-textarea" data-image-field="description"></textarea>
          <label class="label">标签</label>
          <input class="admin-tag-input" type="text" data-image-field="tags" placeholder="tag1 tag2" data-tag-input>
          <p class="hint">编辑标签无需 #，用空格分隔即可。</p>
          <label class="label">分区</label>
          <select class="admin-select" data-image-field="collection"></select>
          <div class="admin-actions-row">
            <button class="btn primary" type="button" data-image-save>保存</button>
            <p class="hint" data-image-status></p>
          </div>
        </div>
      </section>
    </div>
  </main>

  <div class="search-overlay" data-search-overlay aria-hidden="true">
    <div class="search-panel" role="dialog" aria-modal="true">
      <button class="icon-button close-button" type="button" data-search-close aria-label="关闭搜索">×</button>
      <p class="search-title">搜索作品</p>
      <form action="/search/" method="get" class="search-form">
        <input type="search" name="q" placeholder="搜索标题、描述、标签" autocomplete="off" data-search-input>
        <button class="btn primary" type="submit">搜索</button>
      </form>
      <p class="search-hint">支持标签、标题与描述匹配（# 可选）。</p>
    </div>
  </div>

  {% if site.counter.enabled and site.counter.img_url %}
  <div class="counter">
    <img src="{{ site.counter.img_url }}" alt="访问统计" loading="lazy" referrerpolicy="no-referrer">
  </div>
  {% endif %}

  {% if site.live2d.enabled %}
  {% set live2d_width = site.live2d.width or 300 %}
  {% set live2d_height = site.live2d.height or 336 %}
  <div id="landlord" class="live2d-root" aria-hidden="true" style="--live2d-width: {{ live2d_width }}px; --live2d-height: {{ live2d_height }}px;">
    <div class="message" style="opacity:0"></div>
    <canvas id="{{ site.live2d.canvas_id }}" width="{{ live2d_width }}" height="{{ live2d_height }}" class="live2d"></canvas>
  </div>
  <script src="{{ site.live2d.base_url }}/live2d/js/Setting.js" defer onerror="var r=document.getElementById('landlord');if(r){r.style.display='none';}"></script>
  <script src="{{ site.live2d.base_url }}/jquery.min.js" defer onerror="var r=document.getElementById('landlord');if(r){r.style.display='none';}"></script>
  <script src="{{ site.live2d.base_url }}/live2d/js/message.js" defer onerror="var r=document.getElementById('landlord');if(r){r.style.display='none';}"></script>
  <script src="{{ site.live2d.base_url }}/bundle.js" defer onerror="var r=document.getElementById('landlord');if(r){r.style.display='none';}"></script>
  <script>
    window.addEventListener('load', function () {
      if (!window.loadlive2d) return;
      try {
        loadlive2d("{{ site.live2d.canvas_id }}", "{{ site.live2d.model }}");
      } catch (e) {
        const root = document.getElementById('landlord');
        if (root) root.style.display = 'none';
      }
    });
  </script>
  {% endif %}

  <script src="/static/js/ui.js?v={{ static_version }}" defer></script>
  <script src="/static/js/gallery.js?v={{ static_version }}" defer></script>
  <script src="/static/js/user.js?v={{ static_version }}" defer></script>
</body>
</html>
