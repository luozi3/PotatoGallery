<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Status ｜ {{ site_name }}</title>
  <meta name="description" content="{{ site_description }}">
  <meta name="theme-color" content="{{ site.theme_color }}">
  {% include "partials/theme_init.html.j2" %}
  {% if site_url %}
  <link rel="canonical" href="{{ site_url }}/status/">
  {% endif %}
  <link rel="stylesheet" href="/static/styles/gallery.css?v={{ static_version }}">
  <style>
    .page-status {
      font-family: "Source Han Sans SC", "Noto Sans SC", "PingFang SC", "Microsoft YaHei", sans-serif;
      background-color: var(--bg);
      background-image: linear-gradient(180deg, rgba(15, 23, 42, 0.04), rgba(15, 23, 42, 0));
      background-size: 100% 100%;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }

    .status-shell {
      max-width: 1280px;
      margin: 0 auto;
      padding: 32px 80px 72px;
      display: flex;
      flex-direction: column;
      gap: 28px;
    }

    .status-hero {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 320px;
      gap: 24px;
      padding: 24px 26px;
      border: 1px solid var(--border);
      background: var(--panel);
    }

    .status-kicker {
      font-size: 13px;
      letter-spacing: 0.06em;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .status-hero h1 {
      margin: 0 0 6px;
      font-size: 30px;
      letter-spacing: 0.02em;
    }

    .status-subtitle {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

    .status-meta-block {
      display: grid;
      gap: 10px;
      align-content: start;
      padding: 14px 16px;
      border: 1px solid var(--border);
      background: var(--panel-strong);
    }

    .status-meta-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      font-size: 13px;
      letter-spacing: 0.02em;
      font-weight: 500;
    }

    .status-meta-row code {
      font-family: "JetBrains Mono", "SFMono-Regular", Consolas, monospace;
      font-size: 12px;
      color: var(--text);
      background: transparent;
    }

    .status-section {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .status-section-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 15px;
      letter-spacing: 0.04em;
      color: var(--text);
      font-weight: 600;
      padding-left: 12px;
      border-left: 3px solid var(--text);
    }

    .status-section-title::after {
      content: "";
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1px;
      background: var(--border);
      border: 1px solid var(--border);
    }

    .status-block {
      background: var(--panel);
      padding: 18px 20px;
      min-height: 104px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .status-label {
      font-size: 13px;
      letter-spacing: 0.04em;
      color: var(--muted);
      font-weight: 600;
    }

    .status-value {
      font-family: "JetBrains Mono", "SFMono-Regular", Consolas, monospace;
      font-size: 15px;
      color: var(--text);
      line-height: 1.7;
      word-break: break-word;
    }

    .status-charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
      gap: 1px;
      background: var(--border);
      border: 1px solid var(--border);
    }

    .status-chart {
      background: var(--panel);
      padding: 16px 18px 18px;
      display: grid;
      gap: 10px;
    }

    .status-chart-head {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
    }

    .status-meta {
      font-size: 12px;
      color: var(--muted);
      letter-spacing: 0.02em;
    }

    canvas {
      width: 100%;
      height: 180px;
      border: 1px solid var(--border);
      background: var(--panel-strong);
    }

    .status-raw {
      border: 1px solid var(--border);
      background: var(--panel);
      padding: 12px 16px;
    }

    .status-raw summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--text);
      list-style: none;
      letter-spacing: 0.02em;
    }

    .status-raw summary::-webkit-details-marker { display: none; }

    .status-raw summary::before {
      content: "▸";
      display: inline-block;
      margin-right: 8px;
      transition: transform 0.2s var(--ease);
    }

    .status-raw[open] summary::before { transform: rotate(90deg); }

    .status-raw pre {
      margin: 12px 0 0;
      font-size: 13px;
      background: #0b1221;
      color: #e8eefc;
      padding: 12px;
      border-radius: 0;
      overflow-x: auto;
    }

    @media (max-width: 900px) {
      .status-hero {
        grid-template-columns: 1fr;
      }

      .status-meta-block {
        width: 100%;
      }
    }

    @media (max-width: 600px) {
      .status-shell {
        padding: 18px 18px 40px;
        gap: 20px;
      }

      .status-hero {
        grid-template-columns: 1fr;
        gap: 12px;
        padding: 16px;
      }

      .status-kicker {
        display: none;
      }

      .status-hero h1 {
        font-size: 22px;
      }

      .status-subtitle {
        font-size: 12px;
        line-height: 1.5;
      }

      .status-meta-block {
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 8px;
        padding: 10px 12px;
      }

      .status-meta-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 2px;
        font-size: 11px;
      }

      .status-meta-row code {
        font-size: 10px;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .status-section-title {
        letter-spacing: 0.02em;
        font-size: 13px;
      }

      .status-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .status-block {
        padding: 12px;
        min-height: 84px;
      }

      .status-label {
        font-size: 11px;
        line-height: 1.2;
      }

      .status-value {
        font-size: 12px;
        line-height: 1.5;
      }

      .status-charts {
        grid-template-columns: 1fr;
      }

      .status-chart {
        padding: 12px;
        overflow: hidden;
      }

      canvas {
        height: 140px;
      }

      .status-raw summary {
        font-size: 12px;
      }

      .status-raw pre {
        font-size: 11px;
      }
    }
  </style>
</head>
<body class="page-status with-sidebar">
  <a class="skip-link" href="#main-content">跳到主要内容</a>
  {% include "partials/topbar.html.j2" %}
  <main id="main-content" tabindex="-1">
    <div class="home-layout">
      {% include "partials/sidebar_default.html.j2" %}
      <div class="home-main">
        <div class="status-shell">
    <section class="status-hero">
      <div>
        <div class="status-kicker">系统状态</div>
        <h1>运行状态</h1>
        <p class="status-subtitle">静态探针，每次刷新从 <code>/static/status.json</code> 拉取最新数据。</p>
      </div>
      <div class="status-meta-block">
        <div class="status-meta-row">
          <span>来源</span>
          <code>/static/status.json</code>
        </div>
        <div class="status-meta-row">
          <span>刷新间隔</span>
          <span>30 秒</span>
        </div>
        <div class="status-meta-row">
          <span>模式</span>
          <span>只读</span>
        </div>
      </div>
    </section>

    <section class="status-section">
      <div class="status-section-title">总览</div>
      <div class="status-grid" id="status-cards">
        <div class="status-block">
          <div class="status-label">磁盘</div>
          <div class="status-value" id="disk"></div>
        </div>
        <div class="status-block">
          <div class="status-label">图片计数</div>
          <div class="status-value" id="images"></div>
        </div>
        <div class="status-block">
          <div class="status-label">文件计数</div>
          <div class="status-value" id="files"></div>
        </div>
        <div class="status-block">
          <div class="status-label">最近发布</div>
          <div class="status-value" id="build"></div>
        </div>
        <div class="status-block">
          <div class="status-label">CPU / 负载</div>
          <div class="status-value" id="cpu"></div>
        </div>
        <div class="status-block">
          <div class="status-label">内存 / Swap</div>
          <div class="status-value" id="mem"></div>
        </div>
        <div class="status-block">
          <div class="status-label">运行天数</div>
          <div class="status-value" id="uptime"></div>
        </div>
        <div class="status-block">
          <div class="status-label">请求计数</div>
          <div class="status-value" id="requests"></div>
        </div>
      </div>
    </section>

    <section class="status-section">
      <div class="status-section-title">趋势</div>
      <div class="status-charts">
        <div class="status-chart">
          <div class="status-chart-head">
            <div class="status-label">负载（1m）</div>
            <div class="status-meta" id="load-meta"></div>
          </div>
          <canvas id="load-chart-large"></canvas>
        </div>
        <div class="status-chart">
          <div class="status-chart-head">
            <div class="status-label">内存占用 (%)</div>
            <div class="status-meta" id="mem-meta"></div>
          </div>
          <canvas id="mem-chart-large"></canvas>
        </div>
      </div>
    </section>

    <details class="status-raw">
      <summary>原始数据（点击展开）</summary>
      <pre id="raw">加载中...</pre>
    </details>
        </div>
      </div>
    </div>
  </main>

  <script>
    async function loadStatus() {
      try {
        const ts = Date.now();
        const resp = await fetch(`/static/status.json?v=${ts}`, { cache: 'no-cache' });
        const data = await resp.json();
        document.getElementById('raw').textContent = JSON.stringify(data, null, 2);
        const disk = data.disk || {};
        const fmt = (n) => typeof n === 'number' ? (n / 1024 / 1024).toFixed(1) + ' MB' : '未知';
        document.getElementById('disk').textContent =
          `剩余 ${fmt(disk.free)} / 总计 ${fmt(disk.total)} · 磁盘保护：${disk.paused ? '开启' : '关闭'}`;
        const imgs = data.images || {};
        document.getElementById('images').textContent =
          `总数 ${imgs.total || 0} · 已发布 ${imgs.published || 0} · 待发布 ${imgs.processed || 0} · 隔离 ${imgs.quarantined || 0}`;
        document.getElementById('files').textContent =
          `raw ${data.raw_files || 0} · thumb ${data.thumb_files || 0}`;
        const build = data.last_build || {};
        document.getElementById('build').textContent =
          build.id ? `${build.id} @ ${build.published_at || '未知'}` : '无记录';

        const load = data.load || {};
        const [l1, l5, l15] = load.avg || [0, 0, 0];
        const cpus = load.cpus || 1;
        document.getElementById('cpu').textContent =
          `Load ${l1.toFixed(2)}/${l5.toFixed(2)}/${l15.toFixed(2)} · CPU ${cpus}`;
        const mem = data.memory || {};
        const memUsed = mem.total && mem.available ? mem.total - mem.available : 0;
        const memPct = mem.total ? (memUsed / mem.total * 100).toFixed(1) : '0';
        const swapUsed = mem.swap_total && mem.swap_free ? mem.swap_total - mem.swap_free : 0;
        const swapPct = mem.swap_total ? (swapUsed / mem.swap_total * 100).toFixed(1) : '0';
        document.getElementById('mem').textContent =
          `内存 ${fmt(memUsed)} / ${fmt(mem.total)} (${memPct}%) · Swap ${fmt(swapUsed)} / ${fmt(mem.swap_total)} (${swapPct}%)`;

        const uptime = data.uptime || {};
        const siteAge = data.site_age || {};
        const siteSeconds = typeof siteAge.seconds === 'number' ? siteAge.seconds : (siteAge.days || 0) * 86400;
        const bootSeconds = typeof uptime.seconds === 'number' ? uptime.seconds : (uptime.days || 0) * 86400;
        const formatDuration = (seconds) => {
          if (!seconds || seconds <= 0) return '不足 1 小时';
          const days = Math.floor(seconds / 86400);
          const hours = Math.floor((seconds % 86400) / 3600);
          if (days <= 0) {
            return hours <= 0 ? '不足 1 小时' : `${hours} 小时`;
          }
          return `${days} 天 ${hours} 小时`;
        };
        document.getElementById('uptime').textContent =
          `站点运行 ${formatDuration(siteSeconds)} · 服务器上次重启距今 ${formatDuration(bootSeconds)}`;

        const req = data.request_counts || {};
        const reqTotal = req.total || 0;
        const reqPage = req.pages || 0;
        const reqApi = req.api || 0;
        const reqUpdated = req.updated_at ? req.updated_at.split('T')[0] : '';
        document.getElementById('requests').textContent =
          `总请求 ${reqTotal} · 页面 ${reqPage} · API ${reqApi}${reqUpdated ? ` · 更新 ${reqUpdated}` : ''}`;

        renderHistory();
      } catch (err) {
        document.getElementById('raw').textContent = '加载失败：' + err;
      }
    }
    async function renderHistory() {
      try {
        const ts = Date.now();
        const resp = await fetch(`/static/status_history.json?v=${ts}`, { cache: 'no-cache' });
        const history = await resp.json();
        const last = history.slice(-60); // 近期 60 条
        const loadSeries = last.map(x => x.load && x.load.avg ? x.load.avg[0] : 0);
        const memSeries = last.map(x => {
          if (x.memory && x.memory.total) {
            const used = x.memory.total - (x.memory.available || 0);
            return (used / x.memory.total) * 100;
          }
          return 0;
        });
        drawLineChart(document.getElementById('load-chart-large'), loadSeries, 'Load');
        drawLineChart(document.getElementById('mem-chart-large'), memSeries, '内存%');
        document.getElementById('load-meta').textContent = loadSeries.length ? `最近 ${loadSeries.length} 条，当前 ${loadSeries[loadSeries.length - 1].toFixed(2)}` : '暂无历史';
        document.getElementById('mem-meta').textContent = memSeries.length ? `最近 ${memSeries.length} 条，当前 ${memSeries[memSeries.length - 1].toFixed(1)}%` : '暂无历史';
      } catch (err) {
        document.getElementById('load-meta').textContent = '历史加载失败';
        document.getElementById('mem-meta').textContent = '历史加载失败';
      }
    }
    function drawLineChart(canvas, values, label) {
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const w = canvas.width = canvas.clientWidth || 320;
      const h = canvas.height = canvas.clientHeight || 140;
      ctx.clearRect(0, 0, w, h);
      if (!values.length) {
        ctx.fillStyle = '#ccc';
        ctx.fillText('暂无数据', 10, 20);
        return;
      }
      const min = Math.min(...values);
      const max = Math.max(...values);
      const range = max - min || 1;
      const pad = 24;
      const plotW = w - pad * 2;
      const plotH = h - pad * 2;
      // 轴
      ctx.strokeStyle = '#d0d6e0';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(pad, pad);
      ctx.lineTo(pad, h - pad);
      ctx.lineTo(w - pad, h - pad);
      ctx.stroke();
      // 线
      ctx.strokeStyle = '#4c7cff';
      ctx.lineWidth = 2;
      ctx.beginPath();
      values.forEach((v, i) => {
        const x = pad + (i / Math.max(values.length - 1, 1)) * plotW;
        const y = h - pad - ((v - min) / range) * plotH;
        if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
      });
      ctx.stroke();
      // 标注
      ctx.fillStyle = '#555';
      ctx.font = '12px sans-serif';
      ctx.fillText(`${label} max ${max.toFixed(2)}`, pad + 4, pad + 12);
      ctx.fillText(`min ${min.toFixed(2)}`, pad + 4, pad + 26);
    }
    loadStatus();
    setInterval(loadStatus, 30000);
  </script>
  <script src="/static/js/ui.js?v={{ static_version }}" defer></script>
</body>
</html>
