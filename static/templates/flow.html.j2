<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>上传-处理-展示 自检页</title>
  <meta name="description" content="{{ site_description }}">
  <meta name="theme-color" content="{{ site.theme_color }}">
  {% if site_url %}
  <link rel="canonical" href="{{ site_url }}/flow.html">
  {% endif %}
  <style>
    :root {
      --bg: #f7f3ed;
      --card: #ffffff;
      --text: #221c17;
      --muted: #6b625d;
      --border: #e2d9ce;
      --accent: #3d7eff;
      --success: #1f9d55;
      --warn: #ad5b00;
      --error: #b42318;
      --radius: 12px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", "PingFang SC", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 24px;
    }
    .skip-link {
      position: absolute;
      left: -999px;
      top: 16px;
      padding: 8px 10px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      z-index: 10;
    }
    .skip-link:focus { left: 16px; }
    .container { max-width: 960px; margin: 0 auto; }
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .brand-link {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: inherit;
      font-weight: 700;
    }
    .brand-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3d7eff, #7ac6ff);
      box-shadow: 0 0 0 4px rgba(61, 126, 255, 0.16);
    }
    header { margin-bottom: 20px; }
    h1 { margin: 0 0 6px; font-size: 26px; }
    p.lead { margin: 0; color: var(--muted); }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.04);
      margin-bottom: 16px;
    }
    .row { display: grid; gap: 12px; }
    .row.two { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    label { display: block; margin-bottom: 6px; font-weight: 600; }
    input[type="text"], input[type="password"], input[type="file"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #faf8f5;
      font-size: 14px;
    }
    .hint { color: var(--muted); font-size: 13px; margin: 6px 0 0; }
    .checkbox { display: flex; align-items: center; gap: 8px; font-size: 14px; color: var(--muted); }
    button {
      border: none;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 15px;
      cursor: pointer;
    }
    .primary { background: var(--accent); color: #fff; }
    .ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .status {
      padding: 10px 12px;
      border-radius: 10px;
      background: #f2efe9;
      border: 1px dashed var(--border);
      color: var(--muted);
      white-space: pre-wrap;
    }
    .status[data-type="success"] { border-color: #c9e7d6; color: var(--success); background: #f4fbf6; }
    .status[data-type="warn"] { border-color: #ffd89e; color: var(--warn); background: #fff8e8; }
    .status[data-type="error"] { border-color: #f3c3c0; color: var(--error); background: #fff5f4; }
    .result { display: none; }
    .result.show { display: block; }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 10px;
      border-radius: 999px;
      background: #f0ede6;
      color: var(--muted);
      font-size: 13px;
      margin-right: 8px;
    }
    .preview {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items: center;
    }
    .preview img {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #e6e0d6;
    }
    .link { color: var(--accent); text-decoration: none; font-weight: 600; }
    @media (max-width: 640px) {
      body { padding: 16px; }
      .preview { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <a class="skip-link" href="#main-content">跳到主要内容</a>
  <header class="topbar">
    <a class="brand-link" href="/" aria-label="返回首页">
      <span class="brand-dot" aria-hidden="true"></span>
      <span>luozi_sama</span>
    </a>
  </header>
  <div class="container" id="main-content" tabindex="-1">
    <header>
      <h1>上传-处理-展示 自检</h1>
      <p class="lead">面向低配主机的极简联调页：上传 → worker 处理 → 静态发布 → 缩略图/详情可访问。</p>
    </header>

    <div class="card">
      <div class="row two">
        <div>
          <label>认证方式</label>
          <div class="checkbox">
            <input id="auth-basic" name="auth-mode" type="radio" value="basic" checked />
            <label for="auth-basic" style="margin:0;">Basic（推荐，当前 Nginx 需要用户名+口令）</label>
          </div>
          <div class="checkbox">
            <input id="auth-bearer" name="auth-mode" type="radio" value="bearer" />
            <label for="auth-bearer" style="margin:0;">Bearer（仅口令，直连 upload 服务时可用）</label>
          </div>
          <label for="username" style="margin-top:8px;">用户名（Basic 模式）</label>
          <input id="username" name="username" type="text" autocomplete="off" placeholder="默认 gallery，可自行替换" value="gallery" />
          <label for="token" style="margin-top:8px;">口令</label>
          <input id="token" name="token" type="password" autocomplete="off" placeholder="必填：访问 /etc/gallery/upload.env 获取" />
          <div class="checkbox">
            <input id="remember-token" type="checkbox" />
            <label for="remember-token" style="margin:0;">在本机记住口令（localStorage，仅此浏览器）</label>
          </div>
        </div>
        <div>
          <label for="file">选择图片</label>
          <input id="file" name="file" type="file" accept="image/*" />
          <p class="hint">限制 30MB，支持 jpg/png/webp。提交后 worker 自动生成缩略图并发布。</p>
          <p class="hint">请使用 HTTPS 访问本页，避免头部被中间设备剥离。</p>
        </div>
      </div>
      <div class="actions" style="margin-top:12px;">
        <button class="primary" id="start" type="button">上传并检测链路</button>
        <button class="ghost" id="reset" type="button">重置</button>
      </div>
    </div>

    <div class="card">
      <div class="status" id="status" aria-live="polite">等待上传...</div>
    </div>

    <div class="card result" id="result">
      <div style="margin-bottom:10px;">
        <span class="pill">UUID <span id="uuid"></span></span>
        <span class="pill">Raw: <a class="link" id="raw-link" target="_blank" rel="noreferrer">查看</a></span>
        <span class="pill">Thumb: <a class="link" id="thumb-link" target="_blank" rel="noreferrer">查看</a></span>
        <span class="pill">详情页: <a class="link" id="detail-link" target="_blank" rel="noreferrer">访问</a></span>
      </div>
      <div class="preview" id="preview">
        <div>
          <h3 style="margin:0 0 6px;">缩略图</h3>
          <img id="thumb-img" alt="缩略图预览" loading="lazy" />
        </div>
        <div>
          <h3 style="margin:0 0 6px;">处理/发布状态</h3>
          <div class="status" id="poll-status">等待 worker...</div>
        </div>
      </div>
    </div>

    <div class="card">
      <strong>链路说明</strong>
      <ul style="padding-left:20px; margin:8px 0 0;">
        <li>上传接口：<code>POST /upload</code>，需携带 <code>Authorization: Bearer &lt;token&gt;</code> 或 <code>X-Upload-Token</code>。</li>
        <li>写入完成后 worker 轮询 <code>raw/</code>，校验/缩略图/主色 → 生成 <code>www_staging</code> → 原子切换 <code>www</code>。</li>
        <li>本页会使用 HEAD 轮询 <code>/thumb/&lt;uuid&gt;.jpg</code> 与 <code>/images/&lt;uuid&gt;/index.html</code>，最多等待约 90 秒。</li>
        <li>低配主机处理稍慢，如长时间等待可检查系统日志或磁盘空间。</li>
      </ul>
    </div>
  </div>

  <script>
    const startBtn = document.getElementById("start");
    const resetBtn = document.getElementById("reset");
    const statusEl = document.getElementById("status");
    const pollStatusEl = document.getElementById("poll-status");
    const resultEl = document.getElementById("result");
    const uuidEl = document.getElementById("uuid");
    const rawLink = document.getElementById("raw-link");
    const thumbLink = document.getElementById("thumb-link");
    const detailLink = document.getElementById("detail-link");
    const thumbImg = document.getElementById("thumb-img");
    const tokenInput = document.getElementById("token");
    const usernameInput = document.getElementById("username");
    const authBearer = document.getElementById("auth-bearer");
    const authBasic = document.getElementById("auth-basic");
    const fileInput = document.getElementById("file");
    const rememberToken = document.getElementById("remember-token");

    const savedToken = localStorage.getItem("galleryUploadToken");
    if (savedToken) {
      tokenInput.value = savedToken;
      rememberToken.checked = true;
    }

    function setStatus(message, type = "info") {
      statusEl.textContent = message;
      statusEl.dataset.type = type;
    }

    function setPollStatus(message, type = "info") {
      pollStatusEl.textContent = message;
      pollStatusEl.dataset.type = type;
    }

    function resetForm() {
      fileInput.value = "";
      setStatus("等待上传...");
      setPollStatus("等待 worker...");
      resultEl.classList.remove("show");
      thumbImg.removeAttribute("src");
      uuidEl.textContent = "";
      rawLink.removeAttribute("href");
      thumbLink.removeAttribute("href");
      detailLink.removeAttribute("href");
    }

    function persistToken(token) {
      if (rememberToken.checked && token) {
        localStorage.setItem("galleryUploadToken", token);
      } else {
        localStorage.removeItem("galleryUploadToken");
      }
    }

    function getAuthHeader() {
      const token = tokenInput.value.trim();
      const username = usernameInput.value.trim() || "gallery";
      if (authBasic.checked) {
        const raw = `${username}:${token}`;
        const encoded = btoa(unescape(encodeURIComponent(raw)));
        return `Basic ${encoded}`;
      }
      return `Bearer ${token}`;
    }

    async function uploadFile() {
      const token = tokenInput.value.trim();
      const file = fileInput.files[0];
      if (!token) {
        setStatus("请填写上传口令（Bearer 或放在 X-Upload-Token）", "error");
        return;
      }
      if (!file) {
        setStatus("请先选择图片文件", "error");
        return;
      }

      setStatus(`上传中：${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)...`);
      const formData = new FormData();
      formData.append("file", file, file.name);

      let resp;
      try {
        resp = await fetch("/upload", {
          method: "POST",
          headers: { "Authorization": getAuthHeader() },
          body: formData,
        });
      } catch (err) {
        setStatus(`请求失败：${err}`, "error");
        return;
      }

      let data = {};
      try { data = await resp.clone().json(); } catch (_) {}

      if (!resp.ok) {
        setStatus(`上传失败（${resp.status}）：${data.error || resp.statusText}`, "error");
        return;
      }

      persistToken(token);
      const uuid = data.uuid;
      const rawPath = `/${data.stored}`;
      const thumbUrl = `/thumb/${uuid}.jpg`;
      const detailUrl = `/images/${uuid}/index.html`;

      uuidEl.textContent = uuid;
      rawLink.href = rawPath;
      thumbLink.href = thumbUrl;
      detailLink.href = detailUrl;
      thumbImg.alt = `缩略图 ${uuid}`;
      setStatus("上传完成，等待 worker 处理...", "success");
      resultEl.classList.add("show");

      await pollPublish(thumbUrl, detailUrl);
    }

    async function pollOnce(url) {
      try {
        const resp = await fetch(url, { method: "HEAD", cache: "no-store" });
        return resp.ok;
      } catch (_) {
        return false;
      }
    }

    async function pollPublish(thumbUrl, detailUrl) {
      const maxAttempts = 18; // ~90s with 5s 间隔
      const delayMs = 5000;
      for (let attempt = 1; attempt <= maxAttempts; attempt++) {
        const [thumbReady, detailReady] = await Promise.all([pollOnce(thumbUrl), pollOnce(detailUrl)]);
        if (thumbReady || detailReady) {
          thumbImg.src = thumbUrl;
          thumbImg.loading = "lazy";
          setPollStatus(`已发布：thumb=${thumbReady}, detail=${detailReady}`, "success");
          return;
        }
        setPollStatus(`处理发布中（第 ${attempt}/${maxAttempts} 次），等待 ${delayMs / 1000}s...`);
        await new Promise((r) => setTimeout(r, delayMs));
      }
      setPollStatus("超过等待时间，worker 可能仍在处理，请稍后手动刷新链接。", "warn");
    }

    startBtn.addEventListener("click", uploadFile);
    resetBtn.addEventListener("click", resetForm);
  </script>
</body>
</html>
